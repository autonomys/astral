<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GraphQL Subscription Test</title>
    <script src="https://unpkg.com/apollo-client@2.6.10/dist/apollo-client.umd.js"></script>
    <script src="https://unpkg.com/apollo-link-http@1.5.17/dist/apollo-link-http.umd.js"></script>
    <script src="https://unpkg.com/apollo-link-ws@1.0.20/dist/apollo-link-ws.umd.js"></script>
    <script src="https://unpkg.com/apollo-utilities@1.3.4/dist/apollo-utilities.umd.js"></script>
    <script src="https://unpkg.com/apollo-cache-inmemory@1.6.6/dist/apollo-cache-inmemory.umd.js"></script>
    <script src="https://unpkg.com/subscriptions-transport-ws@0.11.0/dist/client.js"></script>
    <script src="https://unpkg.com/graphql-tag@2.12.6/dist/graphql-tag.umd.js"></script>

    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell,
          sans-serif;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        color: #333;
      }
      .environment-buttons {
        margin: 20px 0;
        display: flex;
        gap: 10px;
      }
      button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-selected {
        background-color: #4a6cf7;
        color: white;
      }
      .btn-unselected {
        background-color: #e9e9e9;
        color: #333;
      }
      button:hover {
        opacity: 0.9;
      }
      pre {
        background-color: #f5f5f5;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
      }
      #log {
        margin-top: 20px;
        border-top: 1px solid #ddd;
        padding-top: 10px;
      }
      #log div {
        border-bottom: 1px solid #eee;
        padding: 5px 0;
      }
    </style>
  </head>
  <body>
    <h1>GraphQL Subscription Test</h1>

    <div class="environment-buttons">
      <button id="btn-local" class="btn-selected" onclick="changeEnvironment('local')">
        Local
      </button>
      <button id="btn-mainnet" class="btn-unselected" onclick="changeEnvironment('mainnet')">
        Mainnet
      </button>
      <button id="btn-taurus" class="btn-unselected" onclick="changeEnvironment('taurus')">
        Taurus
      </button>
    </div>

    <div id="endpoint-info"></div>
    <div id="result">Loading...</div>
    <div id="log"></div>

    <script>
      // Environment configurations
      const ENVIRONMENTS = {
        local: {
          http: 'http://localhost:8080/v1/graphql',
          ws: 'ws://localhost:8080/v1/graphql',
          headers: {
            'x-hasura-admin-secret': 'helloworld',
          },
        },
        mainnet: {
          http: 'https://explorer-graphql.autonomys.io/v1/graphql',
          ws: 'wss://explorer-graphql.autonomys.io/v1/graphql',
          headers: {},
        },
        taurus: {
          http: 'https://taurus-explorer-graphql.autonomys.io/v1/graphql',
          ws: 'wss://taurus-explorer-graphql.autonomys.io/v1/graphql',
          headers: {},
        },
      }

      let currentSubscription = null
      let currentEnvironment = 'local'

      // Update UI with current environment
      function updateEnvironmentInfo() {
        const env = ENVIRONMENTS[currentEnvironment]
        document.getElementById('endpoint-info').innerHTML = `
        <p><strong>HTTP:</strong> ${env.http}</p>
        <p><strong>WebSocket:</strong> ${env.ws}</p>
      `

        // Update button states
        Object.keys(ENVIRONMENTS).forEach((key) => {
          const btn = document.getElementById(`btn-${key}`)
          if (key === currentEnvironment) {
            btn.classList.remove('btn-unselected')
            btn.classList.add('btn-selected')
          } else {
            btn.classList.remove('btn-selected')
            btn.classList.add('btn-unselected')
          }
        })
      }

      function addLog(message) {
        const logEl = document.getElementById('log')
        const entry = document.createElement('div')
        entry.textContent = `${new Date().toISOString()}: ${message}`
        logEl.prepend(entry)
      }

      function createClient(environment) {
        const env = ENVIRONMENTS[environment]

        // Set up the HTTP link
        const httpLink = ApolloLink.HttpLink.createHttpLink({
          uri: env.http,
          headers: env.headers,
        })

        // Set up the WebSocket link
        const wsLink = new ApolloLink.WebSocketLink.WebSocketLink({
          uri: env.ws,
          options: {
            reconnect: true,
            connectionParams: {
              headers: env.headers,
            },
            connectionCallback: (error) => {
              if (error) {
                addLog(`WebSocket connection error: ${JSON.stringify(error)}`)
              } else {
                addLog(`WebSocket connected successfully to ${environment}`)
              }
            },
          },
        })

        // Use the right link based on operation
        const link = ApolloLink.ApolloLink.split(
          (operation) => {
            const definition = ApolloUtilities.getMainDefinition(operation.query)
            return (
              definition.kind === 'OperationDefinition' && definition.operation === 'subscription'
            )
          },
          wsLink,
          httpLink,
        )

        // Create the Apollo client
        return new ApolloClient.ApolloClient({
          link,
          cache: new ApolloInMemoryCache.InMemoryCache(),
        })
      }

      function startSubscription(environment) {
        // Cleanup existing subscription if any
        if (currentSubscription) {
          currentSubscription.unsubscribe()
          currentSubscription = null
        }

        const client = createClient(environment)

        // Define subscription
        const subscription = gql`
          subscription {
            consensus_blocks(limit: 5, order_by: { height: desc }) {
              id
              height
              timestamp
            }
          }
        `

        // Reset and show loading state
        document.getElementById('result').innerHTML = 'Loading...'

        // Subscribe
        addLog(`Starting subscription for ${environment}...`)
        currentSubscription = client
          .subscribe({
            query: subscription,
          })
          .subscribe({
            next(response) {
              addLog('Received data')
              document.getElementById('result').innerHTML = `
            <h2>Latest Blocks (${environment})</h2>
            <pre>${JSON.stringify(response.data, null, 2)}</pre>
          `
            },
            error(error) {
              addLog(`Subscription error: ${error.message}`)
              document.getElementById('result').innerHTML = `
            <h2 style="color: red">Error (${environment})</h2>
            <pre>${JSON.stringify(error, null, 2)}</pre>
          `
            },
            complete() {
              addLog('Subscription completed')
            },
          })
      }

      function changeEnvironment(environment) {
        currentEnvironment = environment
        updateEnvironmentInfo()
        startSubscription(environment)
      }

      // Initialize
      updateEnvironmentInfo()
      startSubscription(currentEnvironment)

      // Cleanup on page unload
      window.addEventListener('unload', () => {
        if (currentSubscription) currentSubscription.unsubscribe()
      })
    </script>
  </body>
</html>
